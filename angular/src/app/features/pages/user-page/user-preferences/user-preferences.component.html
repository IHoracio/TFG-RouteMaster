<div class="user-preferences">
    <h2>Preferencias de Usuario</h2>

    <form class="preferences-form">
        <div class="form-group">
            <label for="fuelType">Tipo de Combustible:</label>
            <select id="fuelType" [value]="fuelType()" (change)="setFuelType($event)">
                @for (option of fuelOptions(); track $index) {
                <option [value]="option">{{ capitalize(option) }}</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="brandSearch">Añadir Marca de Gasolinera Favorita:</label>
            <input type="text" [value]="brandSearch()" (input)="setBrandSearch($event)" placeholder="Buscar marca">
            @if (showBrandDropdown() && filteredBrands().length > 0) {
            <ul class="dropdown-list">
                @for (brand of filteredBrands(); track $index) {
                <li (click)="addPreferredBrand(brand)">{{ capitalize(brand) }}</li>
                }
            </ul>
            }
        </div>

        <div class="form-group">
            <label>Marcas de Gasolinera Favoritas:</label>
            <ul>
                @for (brand of preferredBrands(); track $index) {
                <li>{{ capitalize(brand) }} <button type="button"
                        (click)="removePreferredBrand(brand)">Eliminar</button></li>
                }
            </ul>
        </div>

        @if (fuelType() !== 'ELECTRIC') {
        <div class="form-group">
            <label for="precioMaximo">Precio Máximo de Combustible:</label>
            <input id="precioMaximo" type="number" [value]="maxPrice()" (input)="setMaxPrice($event)" min="0"
                step="0.01">
        </div>
        }

        <div class="form-group">
            <label for="mapType">Tipo de Mapa:</label>
            <select id="mapType" [value]="mapType()" (change)="setMapType($event)">
                @for (option of mapTypeOptions(); track $index) {
                <option [value]="option">{{ capitalize(option) }}</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="avoidTolls">Evitar Peajes:</label>
            <input id="avoidTolls" type="checkbox" [checked]="avoidTolls()" (change)="setAvoidTolls($event)">
        </div>

        <div class="form-group">
            <label for="emissionLabel">Etiqueta Medioambiental:</label>
            <select id="emissionLabel" [value]="emissionType()" (change)="setEmissionLabel($event)">
                @for (option of emissionLabelOptions(); track $index) {
                <option [value]="option">{{ capitalize(option) }}</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="theme">Tema:</label>
            <select id="theme" [value]="theme()" (change)="setTheme($event)">
                @for (option of themeOptions(); track $index) {
                <option [value]="option">{{ capitalize(option) }}</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="language">Idioma:</label>
            <select id="language" [value]="language()" (change)="setLanguage($event)">
                @for (option of languageOptions(); track $index) {
                <option [value]="option">{{ capitalize(option) }}</option>
                }
            </select>
        </div>

        <div class="form-group radio-slider">
            <label for="radioKm">Radio KM: <span (click)="toggleInfo()" class="info-icon">ℹ️</span></label>
            <div class="slider-container">
                <input id="radioKm" type="range" [value]="radioKm()" (input)="setRadioKm($event)" min="1" max="15"
                    step="1">
                <span>{{ radioKm() }} km</span>
            </div>
            @if (showRadiusInfo()) {
            <div class="info-tooltip">
                El radio en kilómetros define el área de búsqueda alrededor de la dirección especificada para encontrar
                gasolineras cercanas.
            </div>
            }
        </div>

        <div class="form-group" id="add-gas-stations">
            <label>Añadir Gasolineras Favoritas: <span (click)="toggleGasInfo()" class="info-icon">ℹ️</span></label>
            <input type="text" [value]="searchAddress()" (input)="setSearchAddress($event)"
                placeholder="Escribe una dirección">
            @if (showAddressDropdown() && filteredMunicipalities().length > 0) {
            <ul class="dropdown-list">
                @for (municipality of filteredMunicipalities(); track $index) {
                <li (click)="setMunicipality(municipality)">{{ capitalize(municipality) }}</li>
                }
            </ul>
            }
            <button type="button" (click)="searchGasStations()" [disabled]="isLoading()">Buscar</button>
            @if (isLoading()) {
            <span>Cargando...</span>
            }
            @if (showGasInfo()) {
            <div class="info-tooltip">
                El autocompletado solo sugiere lugares con gasolineras. Puedes ingresar cualquier dirección y aumentar
                el radio KM para buscar más opciones.
            </div>
            }
        </div>

        @if (searchResults().length > 0) {
        <div class="form-group">
            <label>Seleccionar Gasolinera:</label>
            <ul class="gas-stations-list">
                @for (station of searchResults(); track station.idEstacion) {
                @if (isFavorite(station)) {
                <li class="added-station">
                    {{ station.nombreEstacion }} - {{ station.direccion }}
                    <button type="button" (click)="removeFavoriteGasStation(station)">Eliminar</button>
                </li>
                } @else {
                <li (click)="toggleSelection(station)"
                    [class.selected]="selectedStation() === station.nombreEstacion + ' - ' + station.direccion"
                    class="clickable-station">
                    {{ station.nombreEstacion }} - {{ station.direccion }}
                </li>
                }
                }
            </ul>
            <div class="add-favorite-container">
                <input type="text" [value]="alias()" (input)="setAlias($event)" placeholder="Alias para la gasolinera">
                <button type="button" (click)="addSelectedGasStations()"
                    [disabled]="!selectedStation() || !alias().trim()">Añadir Seleccionada</button>
            </div>
        </div>
        } @else if (!isLoading() && hasSearched() && searchResults().length === 0) {
        <div class="form-group">
            <p>No existen gasolineras en {{ searchAddress() }} en un radio de {{ radioKm() }} km</p>
        </div>
        }

        @if (favoriteGasStations().length > 0 || searchResults().length > 0) {
            @if (allStations().length <= 50) {
                      <app-map-page 
                            [showWeather]="false" 
                            [showControls]="false" 
                            [gasStations]="allStations()"
                            [selectedStation]="selectedStation()" 
                            [mapType]="mapType()">
                    </app-map-page>
            } @else {
                <p>Demasiadas gasolineras para mostrar en el mapa. Reduce el radio Km</p>
            }
        }

        <div class="form-group">
            <label>Gasolineras Favoritas:</label>
            <ul>
                @for (station of favoriteGasStations(); track station.idEstacion) {
                <li (click)="setSelectedStation(station)" class="clickable-favorite">
                    {{ station.alias }} - {{ station.nombreEstacion }} - {{ station.direccion }}
                    <button type="button" (click)="removeFavoriteGasStation(station)">Eliminar</button>
                    <button type="button" (click)="renameFavoriteGasStation(station)">Renombrar</button>
                </li>
                }
            </ul>
        </div>

        <div class="buttons">
            <button type="button" (click)="savePreferences()">Guardar Cambios</button>
            <button type="button" (click)="resetPreferences()" [disabled]="!defaultsLoaded()">Reiniciar a Por
                Defecto</button>
        </div>
    </form>
</div>